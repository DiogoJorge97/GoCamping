<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookingBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">goCamping</a> &gt; <a href="index.source.html" class="el_package">BackendBeans</a> &gt; <span class="el_source">BookingBean.java</span></div><h1>BookingBean.java</h1><pre class="source lang-java linenums">/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package BackendBeans;

import Persistencia.Camper;
import Persistencia.Campsite;
import Persistencia.Reservation;
import java.io.Serializable;
import java.time.LocalDate;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import javax.annotation.Resource;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.ManagedProperty;
import javax.faces.bean.SessionScoped;
import javax.faces.context.FacesContext;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import javax.servlet.http.HttpSession;
import javax.transaction.HeuristicMixedException;
import javax.transaction.HeuristicRollbackException;
import javax.transaction.NotSupportedException;
import javax.transaction.RollbackException;
import javax.transaction.SystemException;
import javax.transaction.UserTransaction;

/**
 *
 * @author Andreia Patroc√≠nio
 * @author Carolina Albuquerque
 * @author Diogo Jorge
 * @author Pedro Pires
 * 
 */

@ManagedBean(name = &quot;bookingbean&quot;)
@SessionScoped
<span class="nc" id="L45">public class BookingBean implements Serializable{ </span>
    
    @ManagedProperty(value = &quot;#{fullName}&quot;)
    private String fullName;
    @ManagedProperty(value = &quot;#{email}&quot;)
    private String email;
    @ManagedProperty(value = &quot;#{nrAdults}&quot;)
    private int nrAdults;
    @ManagedProperty(value = &quot;#{nrChildren}&quot;)
    private int nrChildren;
    @ManagedProperty(value = &quot;#{nrBabies}&quot;)
    private int nrBabies;
    @ManagedProperty(value = &quot;#{NIF}&quot;)
    private int NIF;
    @ManagedProperty(value = &quot;#{cellphone}&quot;)
    private int cellphone;
    @ManagedProperty(value = &quot;#{campingCard}&quot;)
    private int campingCard;
    @ManagedProperty (value = &quot;#{totalPrice}&quot;)
    private double totalPrice;
    @ManagedProperty (value=&quot;#{listBooks}&quot;)
    private List&lt;Reservation&gt; listBooks;
   
    @Resource
    UserTransaction utx;

    @PersistenceContext(unitName = &quot;PUnit&quot;)
    private EntityManager em;
    
<span class="nc" id="L74">    private final String sessionGetUser = &quot;username&quot;;</span>
<span class="nc" id="L75">    private final long tresdias = 259200;</span>
    private Reservation reservation;
    private Campsite campsite;
    private Camper camper;
   
    
    
<span class="nc" id="L82">    FacesContext facesContext = FacesContext.getCurrentInstance();</span>
<span class="nc" id="L83">    HttpSession session = (HttpSession) facesContext.getExternalContext().getSession(true);</span>

    
    public Reservation getReservation() {
<span class="nc" id="L87">        return reservation;</span>
    }

    public void setReservation(Reservation reservation) {
<span class="nc" id="L91">        this.reservation = reservation;</span>
<span class="nc" id="L92">    }</span>
   
    public List&lt;Reservation&gt; getListBooks() {
<span class="nc" id="L95">        return listBooks;</span>
    }

    public void setListBooks(List&lt;Reservation&gt; listBooks) {
<span class="nc" id="L99">        this.listBooks = listBooks;</span>
<span class="nc" id="L100">    }</span>
    
    public int getNrBabies() {
<span class="nc" id="L103">        return nrBabies;</span>
    }

    public void setNrBabies(int nrBabies) {
<span class="nc" id="L107">        this.nrBabies = nrBabies;</span>
<span class="nc" id="L108">    }</span>
    
    public double getTotalPrice() {
<span class="nc" id="L111">        return totalPrice;</span>
    }

    public void setTotalPrice(double totalPrice) {
<span class="nc" id="L115">        this.totalPrice =totalPrice;</span>
<span class="nc" id="L116">    }</span>
    
       
    public int getCampingCard() {
<span class="nc" id="L120">        return campingCard;</span>
    }

    public void setCampingCard(int campingCard) {
<span class="nc" id="L124">        this.campingCard = campingCard;</span>
<span class="nc" id="L125">    }</span>
      
    public String getFullName() {
<span class="nc" id="L128">        return fullName;</span>
    }

    public void setFullName(String fullName) {
<span class="nc" id="L132">        this.fullName = fullName;</span>
<span class="nc" id="L133">    }</span>


    public String getEmail() {
<span class="nc" id="L137">        return email;</span>
    }
    

    public void setEmail(String email) {
<span class="nc" id="L142">        this.email = email;</span>
<span class="nc" id="L143">    }</span>

    public int getNrAdults() {
<span class="nc" id="L146">        return nrAdults;</span>
    }

    public void setNrAdults(int nrAdults) {
<span class="nc" id="L150">        this.nrAdults = nrAdults;</span>
<span class="nc" id="L151">    }</span>

    public int getNrChildren() {
<span class="nc" id="L154">        return nrChildren;</span>
    }

    public void setNrChildren(int nrChildren) {
<span class="nc" id="L158">        this.nrChildren = nrChildren;</span>
<span class="nc" id="L159">    }</span>

     public int getNIF(){
<span class="nc" id="L162">        return NIF;</span>
    }
     
    public void setNIF(int NIF) {
<span class="nc" id="L166">        this.NIF = NIF;</span>
<span class="nc" id="L167">    }</span>

    public int getCellphone() {
<span class="nc" id="L170">        return cellphone;</span>
    }

    public void setCellphone(int cellphone) {
<span class="nc" id="L174">        this.cellphone = cellphone;</span>
<span class="nc" id="L175">    }</span>

    public Campsite getCampsite() {
<span class="nc" id="L178">        return campsite;</span>
    }

    public void setCampsite(Campsite campsite) {
<span class="nc" id="L182">        this.campsite = campsite;</span>
<span class="nc" id="L183">    }</span>

    public Camper getCamper() {
<span class="nc" id="L186">        return camper;</span>
    }

    public void setCamper(Camper camper) {
<span class="nc" id="L190">        this.camper = camper;</span>
<span class="nc" id="L191">    }</span>
    
    public Camper searchCamper(String name) {
<span class="nc" id="L194">        Camper user = new Camper();</span>
        try {
<span class="nc" id="L196">            utx.begin();</span>
<span class="nc" id="L197">            Query query = getEntityManager().createQuery(&quot;select c from Camper c where c.username = :name&quot;);</span>
<span class="nc" id="L198">            query.setParameter(&quot;name&quot;, name);</span>
<span class="nc" id="L199">            List&lt;Camper&gt; utilizador = query.getResultList();</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">            for (Iterator&lt;Camper&gt; iterator = utilizador.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L201">                user = (Camper) iterator.next();</span>
            }
<span class="nc" id="L203">            utx.commit();</span>
<span class="nc" id="L204">        } catch (IllegalStateException | SecurityException | HeuristicMixedException | HeuristicRollbackException | NotSupportedException | RollbackException | SystemException e) {</span>
<span class="nc" id="L205">            System.out.println(&quot;camper search didn't work&quot;);</span>
<span class="nc" id="L206">        }</span>
<span class="nc" id="L207">        return user;</span>
    }
    
      public Reservation saveReservation(Date startDate, Date endDate, Camper camper, Campsite campsite, int nrAdults, int nrChildren, int nrBabies, int cellphone, double totalPrice) {
<span class="nc" id="L211">        Reservation reservation = new Reservation();</span>
<span class="nc" id="L212">        System.out.println(&quot;new Reservation&quot;);</span>
        try {
<span class="nc" id="L214">            utx.begin();</span>
<span class="nc" id="L215">            System.out.println(&quot;at the start of transaction&quot;);</span>
<span class="nc" id="L216">            reservation.setStartDate(startDate);</span>
<span class="nc" id="L217">            reservation.setEndDate(endDate);</span>
<span class="nc" id="L218">            reservation.setCamper(camper);</span>
<span class="nc" id="L219">            reservation.setCampsite(campsite);</span>
<span class="nc" id="L220">            reservation.setCellfone(cellphone);</span>
<span class="nc" id="L221">            reservation.setNrAdults(nrAdults);</span>
<span class="nc" id="L222">            reservation.setNrBabies(nrBabies);</span>
<span class="nc" id="L223">            reservation.setNrChildren(nrChildren);</span>
<span class="nc" id="L224">            reservation.setTotalPrice(totalPrice);</span>
<span class="nc" id="L225">            getEntityManager().persist(reservation);</span>
<span class="nc" id="L226">            utx.commit();</span>
<span class="nc" id="L227">        } catch (IllegalStateException | SecurityException | HeuristicMixedException | HeuristicRollbackException | NotSupportedException | RollbackException | SystemException e) {</span>
<span class="nc" id="L228">            System.out.println(&quot;save  didnt' work on reservation&quot;);</span>
<span class="nc" id="L229">        }</span>
<span class="nc" id="L230">        return reservation;</span>
    }

    public List&lt;Reservation&gt; listarReservations(Camper camper) {
<span class="nc" id="L234">        List&lt;Reservation&gt; reservations = new ArrayList&lt;Reservation&gt;();</span>
<span class="nc" id="L235">        List&lt;Reservation&gt; list = new ArrayList&lt;Reservation&gt;();</span>
        try {
<span class="nc" id="L237">            utx.begin();</span>
<span class="nc" id="L238">            Query query = getEntityManager().createQuery(&quot;select c from Reservation as c where c.camper = :camper&quot;);</span>
<span class="nc" id="L239">            query.setParameter(&quot;camper&quot;, camper);</span>
<span class="nc" id="L240">            reservations = query.getResultList();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">            for (Iterator&lt;Reservation&gt; iterator = reservations.iterator(); iterator.hasNext();) {</span>
<span class="nc" id="L242">                Reservation reservation = (Reservation) iterator.next();</span>
<span class="nc" id="L243">                list.add(reservation);</span>
<span class="nc" id="L244">            }</span>
<span class="nc" id="L245">            utx.commit();</span>
<span class="nc" id="L246">        } catch (IllegalStateException | SecurityException | HeuristicMixedException | HeuristicRollbackException | NotSupportedException | RollbackException | SystemException e) {</span>
<span class="nc" id="L247">            System.out.println(&quot;listar reservation with camper didn't work&quot;);</span>
<span class="nc" id="L248">        }</span>
<span class="nc" id="L249">        return list;</span>
    }

    public boolean deleteReservation(int id) {
        try {
<span class="nc" id="L254">            utx.begin();</span>
<span class="nc" id="L255">            Reservation reservation = (Reservation) getEntityManager().find(Reservation.class, id);</span>
<span class="nc" id="L256">            getEntityManager().remove(reservation);</span>
<span class="nc" id="L257">            utx.commit();</span>
<span class="nc" id="L258">            return true;</span>
<span class="nc" id="L259">        } catch (IllegalStateException | SecurityException | HeuristicMixedException | HeuristicRollbackException | NotSupportedException | RollbackException | SystemException e) {</span>
<span class="nc" id="L260">            System.out.println(&quot;delete reservation didn't work&quot;);</span>
<span class="nc" id="L261">            return false;</span>
        }
    }
   
    public String view(Campsite campsiteOutro){
<span class="nc" id="L266">        this.campsite=campsiteOutro;</span>
<span class="nc" id="L267">        this.campingCard=searchCamper(session.getAttribute(sessionGetUser).toString()).getCampsiteCard();</span>
<span class="nc" id="L268">        this.fullName=searchCamper(session.getAttribute(sessionGetUser).toString()).getFullName();</span>
<span class="nc" id="L269">        this.email=searchCamper(session.getAttribute(sessionGetUser).toString()).getEmail();</span>
<span class="nc" id="L270">        return &quot;booking.xhtml&quot;;</span>
    }
    
    public String booking (Date checkin, Date checkout){
<span class="nc" id="L274">        camper = searchCamper(session.getAttribute(sessionGetUser).toString());</span>
<span class="nc" id="L275">        calculatePrice();</span>
<span class="nc" id="L276">        reservation = saveReservation(checkin, checkout, camper, campsite, nrAdults, nrChildren, nrBabies, cellphone, totalPrice);</span>
<span class="nc" id="L277">        listBooks=listarReservations(searchCamper(session.getAttribute(sessionGetUser).toString()));</span>
<span class="nc" id="L278">        return &quot;payment.xhtml&quot;;</span>
    }
    
    public double calculatePrice(){
<span class="nc" id="L282">        double discount = (campsite.getAdultPrice()*(campsite.getCampingCardDiscount()))/100;</span>
<span class="nc" id="L283">        totalPrice = (nrAdults*campsite.getAdultPrice())+(nrChildren*campsite.getChildPrice())+(nrBabies+campsite.getBabyPrice())-discount;</span>
<span class="nc" id="L284">        return totalPrice;</span>
    }
    
    public String cancelReservation(int id, Date startDate){
<span class="nc" id="L288">        LocalDate localDate= LocalDate.now();</span>
<span class="nc" id="L289">        long secsCheckIn=(startDate.getTime()/1000);</span>
<span class="nc" id="L290">        ZoneId zoneId = ZoneId.systemDefault();</span>
<span class="nc" id="L291">        long secsAtual = localDate.atStartOfDay(zoneId).toEpochSecond();</span>
        //so cancela a reserva se for feita 3 dias antes
<span class="nc" id="L293">        long difSecs= secsCheckIn-secsAtual;</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (difSecs&gt;tresdias){</span>
<span class="nc" id="L295">            deleteReservation(id);</span>
<span class="nc" id="L296">            listBooks=listarReservations(searchCamper(session.getAttribute(sessionGetUser).toString()));</span>
<span class="nc" id="L297">            return &quot;myReservations.xhtml&quot;;</span>
        }
<span class="nc" id="L299">        return &quot;myReservations.xhtml&quot;;</span>
    }
    
    
    protected EntityManager getEntityManager() {
<span class="nc" id="L304">        return em;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>