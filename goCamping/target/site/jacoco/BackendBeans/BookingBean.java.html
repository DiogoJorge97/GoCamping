<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookingBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">goCamping</a> &gt; <a href="index.source.html" class="el_package">BackendBeans</a> &gt; <span class="el_source">BookingBean.java</span></div><h1>BookingBean.java</h1><pre class="source lang-java linenums">/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package BackendBeans;

import Persistencia.Camper;
import Persistencia.Campsite;
import Persistencia.Reservation;
import java.io.Serializable;
import java.time.LocalDate;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.Date;
import java.util.Iterator;
import java.util.List;
import javax.annotation.Resource;
import javax.ejb.EJB;
import javax.faces.bean.ManagedBean;
import javax.faces.bean.ManagedProperty;
import javax.faces.bean.SessionScoped;
import javax.faces.context.FacesContext;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;
import javax.servlet.http.HttpSession;
import javax.transaction.HeuristicMixedException;
import javax.transaction.HeuristicRollbackException;
import javax.transaction.NotSupportedException;
import javax.transaction.RollbackException;
import javax.transaction.SystemException;
import javax.transaction.UserTransaction;

/**
 *
 * @author Andreia Patroc√≠nio
 * @author Carolina Albuquerque
 * @author Diogo Jorge
 * @author Pedro Pires
 * 
 */

@ManagedBean(name = &quot;bookingbean&quot;)
@SessionScoped
<span class="nc" id="L46">public class BookingBean implements Serializable{ </span>
    
    @ManagedProperty(value = &quot;#{fullName}&quot;)
    private String fullName;
    @ManagedProperty(value = &quot;#{email}&quot;)
    private String email;
    @ManagedProperty(value = &quot;#{nrAdults}&quot;)
    private int nrAdults;
    @ManagedProperty(value = &quot;#{nrChildren}&quot;)
    private int nrChildren;
    @ManagedProperty(value = &quot;#{nrBabies}&quot;)
    private int nrBabies;
    @ManagedProperty(value = &quot;#{NIF}&quot;)
    private int NIF;
    @ManagedProperty(value = &quot;#{cellphone}&quot;)
    private int cellphone;
    @ManagedProperty(value = &quot;#{campingCard}&quot;)
    private int campingCard;
    @ManagedProperty (value = &quot;#{totalPrice}&quot;)
    private double totalPrice;
    @ManagedProperty (value=&quot;#{listBooks}&quot;)
    private List&lt;Reservation&gt; listBooks;
   
    @EJB
    NewSessionBean newSessionBean;
    
<span class="nc" id="L72">    private final String sessionGetUser = &quot;username&quot;;</span>
<span class="nc" id="L73">    private final long tresdias = 259200;</span>
    private Reservation reservation;
    private Campsite campsite;
    private Camper camper;

<span class="nc" id="L78">    FacesContext facesContext = FacesContext.getCurrentInstance();</span>
<span class="nc" id="L79">    HttpSession session = (HttpSession) facesContext.getExternalContext().getSession(true);</span>

    
    public Reservation getReservation() {
<span class="nc" id="L83">        return reservation;</span>
    }

    public void setReservation(Reservation reservation) {
<span class="nc" id="L87">        this.reservation = reservation;</span>
<span class="nc" id="L88">    }</span>
   
    public List&lt;Reservation&gt; getListBooks() {
<span class="nc" id="L91">        return listBooks;</span>
    }

    public void setListBooks(List&lt;Reservation&gt; listBooks) {
<span class="nc" id="L95">        this.listBooks = listBooks;</span>
<span class="nc" id="L96">    }</span>
    
    public int getNrBabies() {
<span class="nc" id="L99">        return nrBabies;</span>
    }

    public void setNrBabies(int nrBabies) {
<span class="nc" id="L103">        this.nrBabies = nrBabies;</span>
<span class="nc" id="L104">    }</span>
    
    public double getTotalPrice() {
<span class="nc" id="L107">        return totalPrice;</span>
    }

    public void setTotalPrice(double totalPrice) {
<span class="nc" id="L111">        this.totalPrice =totalPrice;</span>
<span class="nc" id="L112">    }</span>
    
       
    public int getCampingCard() {
<span class="nc" id="L116">        return campingCard;</span>
    }

    public void setCampingCard(int campingCard) {
<span class="nc" id="L120">        this.campingCard = campingCard;</span>
<span class="nc" id="L121">    }</span>
      
    public String getFullName() {
<span class="nc" id="L124">        return fullName;</span>
    }

    public void setFullName(String fullName) {
<span class="nc" id="L128">        this.fullName = fullName;</span>
<span class="nc" id="L129">    }</span>


    public String getEmail() {
<span class="nc" id="L133">        return email;</span>
    }
    

    public void setEmail(String email) {
<span class="nc" id="L138">        this.email = email;</span>
<span class="nc" id="L139">    }</span>

    public int getNrAdults() {
<span class="nc" id="L142">        return nrAdults;</span>
    }

    public void setNrAdults(int nrAdults) {
<span class="nc" id="L146">        this.nrAdults = nrAdults;</span>
<span class="nc" id="L147">    }</span>

    public int getNrChildren() {
<span class="nc" id="L150">        return nrChildren;</span>
    }

    public void setNrChildren(int nrChildren) {
<span class="nc" id="L154">        this.nrChildren = nrChildren;</span>
<span class="nc" id="L155">    }</span>

     public int getNIF(){
<span class="nc" id="L158">        return NIF;</span>
    }
     
    public void setNIF(int NIF) {
<span class="nc" id="L162">        this.NIF = NIF;</span>
<span class="nc" id="L163">    }</span>

    public int getCellphone() {
<span class="nc" id="L166">        return cellphone;</span>
    }

    public void setCellphone(int cellphone) {
<span class="nc" id="L170">        this.cellphone = cellphone;</span>
<span class="nc" id="L171">    }</span>

    public Campsite getCampsite() {
<span class="nc" id="L174">        return campsite;</span>
    }

    public void setCampsite(Campsite campsite) {
<span class="nc" id="L178">        this.campsite = campsite;</span>
<span class="nc" id="L179">    }</span>

    public Camper getCamper() {
<span class="nc" id="L182">        return camper;</span>
    }

    public void setCamper(Camper camper) {
<span class="nc" id="L186">        this.camper = camper;</span>
<span class="nc" id="L187">    }</span>
    
    public String view(Campsite campsiteOutro){
<span class="nc" id="L190">        this.campsite=campsiteOutro;</span>
<span class="nc" id="L191">        Camper c = newSessionBean.searchCamper(session.getAttribute(sessionGetUser).toString());</span>
<span class="nc" id="L192">        this.campingCard=c.getCampsiteCard();</span>
<span class="nc" id="L193">        this.fullName=c.getFullName();</span>
<span class="nc" id="L194">        this.email=c.getEmail();</span>
<span class="nc" id="L195">        this.NIF=c.getNIF();</span>
<span class="nc" id="L196">        return &quot;booking.xhtml&quot;;</span>
    }
    
    public String booking (Date checkin, Date checkout){
<span class="nc" id="L200">        camper = newSessionBean.searchCamper(session.getAttribute(sessionGetUser).toString());</span>
<span class="nc" id="L201">        calculatePrice();</span>
<span class="nc" id="L202">        reservation = newSessionBean.saveReservation(checkin, checkout, camper, campsite, nrAdults, nrChildren, nrBabies, cellphone, totalPrice);</span>
<span class="nc" id="L203">        listBooks=newSessionBean.listarReservations(newSessionBean.searchCamper(session.getAttribute(sessionGetUser).toString()));</span>
<span class="nc" id="L204">        return &quot;payment.xhtml&quot;;</span>
    }
    
    public double calculatePrice(){
<span class="nc" id="L208">        double discount = (campsite.getAdultPrice()*(campsite.getCampingCardDiscount()))/100;</span>
<span class="nc" id="L209">        totalPrice = (nrAdults*campsite.getAdultPrice())+(nrChildren*campsite.getChildPrice())+(nrBabies+campsite.getBabyPrice())-discount;</span>
<span class="nc" id="L210">        return totalPrice;</span>
    }
    
    public String cancelReservation(int id, Date startDate){
<span class="nc" id="L214">        LocalDate localDate= LocalDate.now();</span>
<span class="nc" id="L215">        long secsCheckIn=(startDate.getTime()/1000);</span>
<span class="nc" id="L216">        ZoneId zoneId = ZoneId.systemDefault();</span>
<span class="nc" id="L217">        long secsAtual = localDate.atStartOfDay(zoneId).toEpochSecond();</span>
        //so cancela a reserva se for feita 3 dias antes
<span class="nc" id="L219">        long difSecs= secsCheckIn-secsAtual;</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (difSecs&gt;tresdias){</span>
<span class="nc" id="L221">            newSessionBean.deleteReservation(id);</span>
<span class="nc" id="L222">            listBooks=newSessionBean.listarReservations(newSessionBean.searchCamper(session.getAttribute(sessionGetUser).toString()));</span>
<span class="nc" id="L223">            return &quot;myReservations.xhtml&quot;;</span>
        }
<span class="nc" id="L225">        return &quot;myReservations.xhtml&quot;;</span>
    }
    
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.8.201612092310</span></div></body></html>